import { jsxs as _jsxs, jsx as _jsx, Fragment as _Fragment } from "react/jsx-runtime";
import clsx from "clsx";
import { ChevronDown, ChevronUp } from "lucide-react";
import React, { useEffect, useRef, useState } from "react";
import { Button } from "../../../Button";
import { IconButton } from "../../../IconButton";
import { Separator } from "../../../Separator";
const formatPercentage = (value, total) => {
    const percentage = (value / total) * 100;
    return `${percentage.toFixed(1)}%`;
};
const ITEM_HEIGHT = 36; // Height of each legend item
const ITEM_GAP = 2; // Gap between items
const LEGEND_ITEM_LIMIT = 6;
const SHOW_MORE_BREAKPOINT = 450;
export const StackedLegend = ({ items, onItemHover, activeKey, onLegendItemHover, containerWidth, separator = false, showTitle = true, layout = "auto", className, style, }) => {
    const containerRef = useRef(null);
    const listRef = useRef(null);
    const [showUpButton, setShowUpButton] = useState(false);
    const [showDownButton, setShowDownButton] = useState(false);
    const [showAll, setShowAll] = useState(false);
    const [isOverflowing, setIsOverflowing] = useState(false);
    // Determine the actual layout to use
    const isShowMoreLayout = layout === "showMore" ||
        (layout === "auto" &&
            containerWidth !== undefined &&
            (containerWidth < SHOW_MORE_BREAKPOINT || items.length > LEGEND_ITEM_LIMIT));
    const isScrollableLayout = layout === "scrollable" || (layout === "auto" && !isShowMoreLayout);
    const handleMouseEnter = (key, index) => {
        onItemHover?.(key);
        onLegendItemHover?.(index);
    };
    const handleMouseLeave = () => {
        onItemHover?.(null);
        onLegendItemHover?.(null);
    };
    // Check if scrolling is needed
    useEffect(() => {
        const checkScroll = () => {
            if (listRef.current && containerRef.current) {
                const { scrollTop, scrollHeight, clientHeight } = listRef.current;
                const overflowing = scrollHeight > clientHeight;
                setIsOverflowing(overflowing);
                setShowUpButton(scrollTop > 0);
                setShowDownButton(scrollTop < scrollHeight - clientHeight - 1);
            }
        };
        if (isShowMoreLayout) {
            setShowUpButton(false);
            setShowDownButton(false);
            return;
        }
        // Initial check
        checkScroll();
        // Add event listener for scroll
        const currentRef = listRef.current;
        if (currentRef) {
            currentRef.addEventListener("scroll", checkScroll);
            // Also add resize observer to handle responsive changes
            const resizeObserver = new ResizeObserver(checkScroll);
            resizeObserver.observe(currentRef);
            return () => {
                currentRef.removeEventListener("scroll", checkScroll);
                resizeObserver.disconnect();
            };
        }
        return () => { };
    }, [isShowMoreLayout]);
    // Scroll functions
    const scrollUp = () => {
        if (listRef.current) {
            // Scroll one item up
            listRef.current.scrollBy({ top: -(ITEM_HEIGHT + ITEM_GAP), behavior: "smooth" });
        }
    };
    const scrollDown = () => {
        if (listRef.current) {
            // Scroll one item down
            listRef.current.scrollBy({ top: ITEM_HEIGHT + ITEM_GAP, behavior: "smooth" });
        }
    };
    // Calculate total for percentage
    const total = items.reduce((sum, item) => sum + item.value, 0);
    // Items are already sorted by the parent component, so we use them as-is
    const itemsToDisplay = isShowMoreLayout && !showAll ? items.slice(0, 6) : items;
    return (_jsxs("div", { ref: containerRef, className: clsx("crayon-stacked-legend-container", className), style: {
            width: containerWidth ? `${containerWidth}px` : "100%",
            ...style,
        }, children: [(showTitle || (isScrollableLayout && isOverflowing)) && (_jsxs("div", { className: "crayon-stacked-legend-header", children: [showTitle && (_jsxs("div", { className: "crayon-stacked-legend-header-title", children: [items.length, " values"] })), _jsx("div", { className: "crayon-stacked-legend-header-buttons", children: isScrollableLayout && isOverflowing && (_jsxs(_Fragment, { children: [_jsx(IconButton, { className: "crayon-stacked-legend-scroll-button crayon-stacked-legend-scroll-up", onClick: scrollUp, "aria-label": "Scroll legend up", icon: _jsx(ChevronUp, {}), variant: "secondary", size: "extra-small", disabled: !showUpButton }), _jsx(IconButton, { className: "crayon-stacked-legend-scroll-button crayon-stacked-legend-scroll-down", onClick: scrollDown, "aria-label": "Scroll legend down", icon: _jsx(ChevronDown, {}), variant: "secondary", size: "extra-small", disabled: !showDownButton })] })) })] })), _jsx("div", { ref: listRef, className: "crayon-stacked-legend", children: itemsToDisplay.map((item, index) => (_jsxs(React.Fragment, { children: [_jsxs("div", { className: `crayon-stacked-legend__item ${activeKey === item.key ? "crayon-stacked-legend__item--active" : ""}`, onMouseEnter: () => handleMouseEnter(item.key, index), onMouseLeave: handleMouseLeave, children: [_jsxs("div", { className: "crayon-stacked-legend__item-label", children: [_jsx("div", { className: "crayon-stacked-legend__item-color-container", children: _jsx("div", { className: "crayon-stacked-legend__item-color", style: { backgroundColor: item.color } }) }), _jsx("div", { className: "crayon-stacked-legend__item-label-text", children: item.label })] }), _jsx("div", { className: "crayon-stacked-legend__item-value", children: formatPercentage(item.value, total) })] }), index !== itemsToDisplay.length - 1 && separator && (_jsx(Separator, { className: "crayon-stacked-legend-separator" }))] }, item.key))) }), isShowMoreLayout && !showAll && items.length > LEGEND_ITEM_LIMIT && (_jsx(Button, { variant: "secondary", size: "small", onClick: () => setShowAll(true), className: "crayon-stacked-legend-show-more-button", children: "Show more" })), isShowMoreLayout && showAll && items.length > LEGEND_ITEM_LIMIT && (_jsx(Button, { variant: "secondary", size: "small", onClick: () => setShowAll(false), className: "crayon-stacked-legend-show-less-button", children: "Show less" }))] }));
};
//# sourceMappingURL=StackedLegend.js.map